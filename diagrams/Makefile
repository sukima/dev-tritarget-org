# Makefile for PlantUML
# Author: Devin Weaver (@sukima) <suki@tritarget.org>
# GistID: 52eacde54bf7861b19ee66a07b864583
#
# This handles SVGs PNGs and ASCII outputs.
# It handles included files with the .iuml extension: !include foo.iuml
# All diagrams have the .uml extension and reside in the diagrams directory
# All output is saved to the output directory
#
# make svg    - (default) build all diagrams as SVGs
# make png    - build all diagrams as PNGs
# make ascii  - build all diagrams as ACII Art text files (.atxt)
# make all    - build SVG, PNG, and ASCII files
# make depend - build the dependency cache (also done automatically)
# make clean  - clean up build artifacts and output files
#
# Diagrams can be built in parrallel with `make -j`.

# If you installed plantuml from Homebrew (brew install plantuml) use this:
PLANTUML = plantuml
# PLANTUML = java -jar bin/plantuml.jar

SRC = .
OUTPUT = ../tiddlers/diagrams
DEPEND = .depend

SRC_FILES := $(wildcard $(SRC)/*.uml)

TIDDLER_NOW := $(shell date +%Y%m%d%H%M%S000)

.PHONY: default depend clean

default: svg

depend: $(DEPEND)

clean:
	rm -f $(patsubst $(SRC)/%.uml,$(OUTPUT)/%.svg,$(SRC_FILES))
	rm -f $(patsubst $(SRC)/%.uml,$(OUTPUT)/%.svg.meta,$(SRC_FILES))
	rm -f $(SRC)/*.png
	rm -f $(DEPEND)

svg: $(DEPEND)
	@$(MAKE) $(patsubst $(SRC)/%.uml,$(OUTPUT)/%.svg.meta,$(shell ls -1t $(SRC_FILES)))
	@$(MAKE) $(patsubst $(SRC)/%.uml,$(OUTPUT)/%.svg,$(shell ls -1t $(SRC_FILES)))

png: $(DEPEND)
	@$(MAKE) $(patsubst $(SRC)/%.uml,$(SRC)/%.png,$(shell ls -1t $(SRC_FILES)))

%.png: $(SRC)/%.uml
	$(PLANTUML) -tpng $< -o $(SRC)

$(OUTPUT)/%.svg: $(SRC)/%.uml
	$(PLANTUML) -tsvg $< -o $(OUTPUT)

$(OUTPUT)/%.svg.meta:
	@echo "creator: Sukima" > $@; \
	echo "created: $(TIDDLER_NOW)" >> $@; \
	echo "modified: $(TIDDLER_NOW)" >> $@; \
	echo "tags: Diagrams" >> $@; \
	echo "title: $(notdir $(@:.meta=))" >> $@; \
	echo "type: image/svg+xml" >> $@; \
	echo "Created \`$@'"

$(DEPEND): $(SRC_FILES)
	@find_includes() { \
		sed \
			-e "s,^[[:space:]]*!include \([^<].*[^>]\)$$,$${1}/\1," \
			-e t -e d "$$2" \
			| paste -sd " " -; \
	}; \
	echo "# GENERATED BY make depend" > $@; \
	echo "# DO NOT EDIT" >> $@; \
	echo >> $@; \
	for file in $^; do \
		name="$$(basename -s .uml "$$file")"; \
		includes="$$(find_includes "$(SRC)" "$$file")"; \
		printf "$(OUTPUT)/%s.svg: %s\n" "$$name" "$$includes"; \
		printf "$(OUTPUT)/%s.png: %s\n" "$$name" "$$includes"; \
	done >> $@

-include $(DEPEND)
